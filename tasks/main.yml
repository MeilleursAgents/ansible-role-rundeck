---
# tasks file for rundeck
- name: create rundeck directories
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - "{{ rundeck_rdeckbase }}"
    - "{{ rundeck_rdeckbase }}/etc"
    - "{{ rundeck_rdeckbase }}/var"

- name: download rundeck
  get_url:
    url: "{{ rundeck_download_url }}/{{ rundeck_jar }}"
    dest: "{{ rundeck_rdeckbase }}/{{ rundeck_jar }}"

- name: register rundeck to a sysvinit system
  template:
    src: templates/rundeck.j2
    dest: "/etc/init.d/rundeck"
    mode: 0750
  when:
    - ansible_service_mgr == "sysvinit" or ansible_service_mgr == "upstart"

- name: register rundeck to a systemd system
  template:
    src: templates/rundeck.service.j2
    dest: /etc/systemd/system/rundeck.service
  when:
    - ansible_service_mgr == "systemd"
  notify:
    - systemd daemon reload

- name: unpack rundeck
  command: java -jar rundeck-launcher-2.10.6.jar
  args:
    chdir: "{{ rundeck_rdeckbase }}"
    creates: "{{ rundeck_rdeckbase }}/server/"
  async: 1
  poll: 0
  notify:
    - wait until unpacked

- name: flush_handlers
  meta: flush_handlers

- name: configure rundeck profile
  template:
    src: templates/profile.j2
    dest: "{{ rundeck_rdeckbase }}/etc/profile"

- name: configure rundeck properties
  lineinfile:
    dest: "{{ rundeck_rdeckbase }}/server/config/rundeck-config.properties"
    line: "{{ item.parameter }} = {{ item.value }}"
    regexp: "^{{ item.parameter }}"
    create: yes
  notify: restart rundeck
  with_items:
    - "{{ rundeck_config }}"

- name: configure rundeck framework
  lineinfile:
    dest: "{{ rundeck_rdeckbase }}/etc/framework.properties"
    line: "{{ item.parameter }} = {{ item.value }}"
    regexp: "^{{ item.parameter }}"
    create: yes
  notify: restart rundeck
  with_items:
    - "{{ rundeck_framework }}"

- name: start rundeck
  service:
    name: rundeck
    state: started
    enabled: true
  when:
    - ansible_virtualization_type != "docker"
